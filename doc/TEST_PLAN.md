# K12KB — Тест-план

## Обзор

K12KB — кастомная Android IME (Input Method Editor) для устройств с аппаратной клавиатурой (BlackBerry KEY1/KEY2, Unihertz Titan/Slim/Pocket). Тест-план охватывает все функциональные области с приоритетами P0 (критический) — P3 (низкий).

**Целевые устройства:** BlackBerry KEY2 (Android 8.1, API 26), Unihertz Titan Slim (API 28+)
**APK:** debug-подпись, сборка через `tools/build_apk.sh`

---

## P0 — Критический (Обязательно перед любым релизом)

### TP-001: Жизненный цикл IME

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Активация IME после включения | Настройки → Язык и ввод → включить K12KB → выбрать по умолчанию | `K12KbIME.onCreateInputView()` срабатывает, вьюха клавиатуры загружается |
| 2 | IME переживает убийство процесса | Открыть приложение → принудительно остановить K12KB → вернуться в текстовое поле | IME перезапускается, статический движок `WordPredictor` переживает или корректно перезагружается |
| 3 | IME при смене конфигурации | Поворот устройства / смена системной локали | `onConfigurationChanged` отрабатывает без краша, раскладка перезагружается |
| 4 | Переключение IME вкл/выкл | Системные настройки → выключить K12KB пока активен в приложении | Приложение переключается на другую IME без ANR |

### TP-002: Базовый ввод с аппаратной клавиатуры

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Ввод одного символа | Нажать клавишу 'a' (короткое нажатие) | 'a' коммитится в `InputConnection`, корректный `KeyEvent.KEYCODE_A` в `ActivityKeyboardTest` |
| 2 | Shift + символ | Нажать Shift, затем 'a' | 'A' коммитится, состояние shift сбрасывается после символа |
| 3 | Backspace | Набрать "hello", нажать DEL | Остаётся "hell" |
| 4 | Enter | Фокус на однострочном EditText, нажать Enter | Выполняется действие из `EditorInfo.imeOptions` (search/done/next) |
| 5 | Пробел | Нажать пробел после набранного слова | Пробел коммитится, срабатывает предсказание следующего слова |

### TP-003: Стейт-машина обработки клавиш

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Короткое нажатие | Нажать и отпустить в пределах `time-short-press` (~250мс) | Срабатывает действие короткого нажатия из `keyboard_mechanics.json` |
| 2 | Двойное нажатие | Нажать дважды в пределах `time-double-press` | Срабатывает вариант `KeyVariants.DoublePress` |
| 3 | Тройное нажатие | Нажать трижды в пределах `time-triple-press` | Срабатывает действие тройного нажатия |
| 4 | Долгое нажатие | Удержать клавишу > `time-long-press` (~500мс) | Срабатывает действие долгого нажатия (альтернативный символ) |
| 5 | Долгое после короткого | Короткое нажатие, затем сразу долгое | Таймаут `time-long-after-short-press` корректно учитывается |
| 6 | Удержание с повтором | Удержать клавишу > порога долгого нажатия, продолжить удержание | Генерируются события повтора с настроенной частотой |

### TP-004: Предсказание слов (Native SymSpell)

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Базовое предложение | Набрать "hel" | SuggestionBar показывает "hello", "help", "hell" (сортировка по частоте) |
| 2 | Исправление опечатки | Набрать "helo" | "hello" появляется первым предложением (distance=1) |
| 3 | Принять предложение | Набрать "helo", тапнуть предложение "hello" | "hello" заменяет "helo" в текстовом поле, автоматически добавляется пробел |
| 4 | Предсказание следующего слова | Набрать "the " (с пробелом) | Появляются биграмные предложения: "same", "first", "best" и т.д. |
| 5 | Сохранение регистра | Набрать "Hello" (заглавная H) → принять предложение | Результат сохраняет FirstCap регистр |
| 6 | Режим ALL_CAPS | Caps Lock включён, набрать "HELO" | Предложение применяется как "HELLO" |
| 7 | Загрузка словаря | Первое использование после установки / очистки кэша | Словарь загружается асинхронно, предложения появляются после загрузки (без ANR) |
| 8 | Переключение предсказания | Настройки → отключить предсказание | SuggestionBar скрыт, предсказания не вычисляются |

---

## P1 — Высокий приоритет (Обязательно перед публичным релизом)

### TP-005: Переключение языков

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Переключить язык | Нажать клавишу переключения языка (по умолчанию: двойное нажатие KEY0) | Раскладка переключается (EN → RU), уведомление обновляется |
| 2 | Корректность раскладки | Переключиться на RU, нажать клавишу 'q' | Выводится 'й' (маппинг ЙЦУКЕН) |
| 3 | Язык предсказания следует | Переключить EN → RU | WordPredictor перезагружает RU-словарь, предложения на русском |
| 4 | Циклическое переключение | Настроить 3+ раскладки, циклически переключать | Переключение по порядку, зацикливается |

### TP-006: Жесты для управления курсором

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Горизонтальный жест | Коснуться области клавиатуры, провести вправо | Курсор перемещается вправо в текстовом поле |
| 2 | Вертикальный жест | Коснуться и провести вверх | Курсор перемещается на строку вверх |
| 3 | Чувствительность жестов | Изменить чувствительность жестов в настройках | Формула `motion_delta_min = (GESTURE_MOTION_CONST - sensitivity) * Kpower` обновляется |
| 4 | Границы строк жестов | Жест начинается из области row4 (`gesture-row4-begin-y`) | Жест корректно определяется по Y-координатe |
| 5 | Двойной/тройной тап жестом | Двойной тап на сенсоре клавиатуры | Выделение слова/строки через `ProcessDoubleTripleGestureClick()` |
| 6 | Уведомление режима жестов | Войти в режим жестов | NotificationProcessor показывает уведомление режима жестов |

### TP-007: Экранная клавиатура (OSK)

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Отображение OSK | Активировать OSK (настроенная клавиша) | `SatedaKeyboard` рендерится с правильной темой |
| 2 | Нажатие клавиши OSK | Тапнуть клавишу на OSK | Символ коммитится через коллбэк `onKey()` |
| 3 | Скрытие OSK | Нажать назад / аппаратную клавишу | OSK скрывается, аппаратный ввод возобновляется |
| 4 | OSK соответствует раскладке | Переключить язык, открыть OSK | OSK показывает ту же раскладку, что и аппаратный маппинг |

### TP-008: Сохранение настроек

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Сохранение/загрузка | Изменить движок предсказания, перезапустить IME | `K12KbSettings` читает из SharedPreferences `kbsettings`, настройка сохраняется |
| 2 | Экспорт в JSON | Настройки → Экспорт → /sdcard/K12Kb/settings.json | Записывается валидный JSON с 40+ ключами предпочтений |
| 3 | Импорт из JSON | Изменить экспортированный JSON, импортировать | Все настройки корректно восстановлены |
| 4 | Переключение тёмной темы | Переключить тёмную тему в настройках | Все активити (Settings, Main, KeyboardTest, PredictionSettings) применяют тёмную тему |

### TP-009: Перевод

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Предложения перевода | Включить перевод, набрать слово | Перевод появляется в SuggestionBar (синий цвет `candidate_translation`) |
| 2 | Переключение предсказание/перевод | Переключить режим между предсказанием и переводом | UI обновляется, правильный движок активен |
| 3 | Перевод фразы | Набрать многословную фразу | Фразовый словарь возвращает перевод |

---

## P2 — Средний приоритет (Желательно перед публичным релизом)

### TP-010: Accessibility Service

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Активация сервиса | Включить K12KB Accessibility Service | `K12KbAccessibilityService` зарегистрирован, конфиг загружен из `k12kb_as_options.json` |
| 2 | Прямоугольный оверлей | Навигация с фокусом доступности | Прямоугольный оверлей отрисовывается по границам сфокусированного узла |
| 3 | Хак цифровой панели | Активировать фичу цифровой панели | Корректная инъекция цифр в сфокусированное поле |

### TP-011: Поисковые плагины

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Загрузка плагина из JSON | Плагин настроен в `plugin_data.json` | `SearchClickPlugin` загружается и находит целевое приложение |
| 2 | Автоклик по полю поиска | Открыть настроенное приложение, вызвать поиск | Accessibility Service автоматически фокусирует поле поиска |
| 3 | JS-патч данных плагина | Применить `plugin_data.test.del_plugin.js` | Плагин удалён из конфигурации через Rhino-патчинг |

### TP-012: JavaScript-патчинг

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Патч таймингов ядра | Поместить `keyboard_core.lp700.js` в пользовательскую папку | Таймаут долгого нажатия обновляется до 700мс через Rhino-патч |
| 2 | Патч механик | Применить `keyboard_mechanics.ctrl_lang_switch.js` | Поведение Ctrl+клавиша изменяется согласно патчу |
| 3 | Варианты загрузки патчей | Проверить `FileJsonUtils.CustomizationLoadVariants` в KeyboardTest | Показывает какие конфиги использовали Default/Custom/JsPatched |
| 4 | Невалидный JS-патч | Поместить сломанный .js файл | Грациозная обработка ошибки, откат к конфигу по умолчанию |

### TP-013: Каналы уведомлений

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Уведомление раскладки | Переключить раскладку клавиатуры | Постоянное уведомление показывает название текущей раскладки |
| 2 | Уведомление режима жестов | Войти в режим жестов | Канал уведомлений режима жестов показывает статус |
| 3 | Тап по уведомлению | Тапнуть уведомление раскладки | Открываются настройки/активити K12KB |

### TP-014: Устройство-специфичные раскладки

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Автоопределение устройства | Установить на KEY2 vs Unihertz Slim | `KeyboardLayoutOptions.device_regex` совпадает, загружается правильная раскладка |
| 2 | Устройство-специфичные механики | Установить на Unihertz | Применяются JS-патчи для Unihertz (`unihertz_keyboard_mechanics.*`) |
| 3 | Пользовательский файл механик | Поместить кастомный `keyboard_mechanics.json` на sdcard | Кастомный файл загружается по цепочке `FileJsonUtils` |

---

## P3 — Низкий приоритет (Желательно)

### TP-015: Нативный код

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Unit-тесты SymSpell | Запустить бинарник `test_symspell` на хосте | Все ассерты проходят: basic lookup, prefix, save/load v2/v3, bigrams |
| 2 | Keyboard-aware расстояние | Поиск "hrllo" (r рядом с e на QWERTY) | Расстояние меньше чем для "hzllo" (z далеко от e), стоимость соседних клавиш 0.5 |
| 3 | CDB-кэш | Загрузить словарь, проверить создание `.ssnd` кэша | `getFilesDir()/native_dict_cache/{locale}.ssnd` существует и загружается через mmap |
| 4 | Варианты размера словаря | Установить dict_size = 35000 / 150000 / 300000 | Загружается правильное количество слов, производительность приемлема |
| 5 | Потокобезопасность JNI | Вызвать предсказания из нескольких потоков | Без SIGSEGV, без повреждения данных |

### TP-016: Граничные случаи

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Пустой ввод | Открыть текстовое поле, не набирать | Без краша, без ложных предложений |
| 2 | Очень длинное слово | Набрать строку 50+ символов | `MAX_WORD_LENGTH=48` соблюдается, без переполнения буфера |
| 3 | Быстрое мэшинг клавиш | Быстро нажимать много клавиш | Стейт-машина обрабатывает конкурентные записи в `KeyDownList1` |
| 4 | Комбинации модификаторов | Ctrl+Shift+Alt+клавиша | Битовая маска meta state обрабатывается корректно в `onKeyDown` |
| 5 | Unicode ввод | Набрать эмодзи или CJK-символы через вставку | Без краша в движке предсказания (обработка не-ASCII) |
| 6 | Мало памяти | Спровоцировать нехватку памяти | IME обрабатывает `onTrimMemory`, предсказание деградирует грациозно |

### TP-017: Сборка и упаковка

| # | Тест-кейс | Шаги | Ожидаемый результат |
|---|-----------|------|---------------------|
| 1 | Скрипт ручной сборки | Запустить `tools/build_apk.sh` | APK создан, подписан, zipalign, ~4MB |
| 2 | CI скрипт сборки | Запустить `tools/build_ci.sh` | APK создан с патчами совместимости для API 23 |
| 3 | APK устанавливается | `adb install K12KB-*.apk` на целевом устройстве | Устанавливается без ошибок |
| 4 | Информация о версии | Проверить versionCode/versionName APK | Совпадает со значениями в `build_apk.sh` |
| 5 | Отсутствие lambda/streams | Grep исходников на `->` lambda-синтаксис | Ноль совпадений (предотвращение BootstrapMethodError на Android 8.x dex) |

---

## Тестовое окружение

| Параметр | Значение |
|----------|----------|
| Хост сборки | Ubuntu 24.04 x86_64 |
| JDK | Eclipse Temurin 11.0.30 |
| Android SDK | API 28 (android.jar), build-tools 28.0.3 |
| DEX инструмент | dalvik-exchange `dx` |
| Подпись | debug.keystore (androiddebugkey / android) |
| Основное устройство | BlackBerry KEY2, Android 8.1 (API 27) |
| Дополнительное устройство | Unihertz Titan Slim, Android 11+ (API 28+) |
| Тест-активити | `ActivityKeyboardTest` — отображает KeyEvent коды, meta state, MotionEvent info, дебаг-лог |

## Тестовые данные

- Английский словарь: `app/src/main/assets/dictionaries/en_base.txt`
- Раскладки клавиатуры: `app/src/main/assets/keyboard_layouts.json`
- Конфиг таймингов ядра: `app/src/main/assets/keyboard_core.json`
- Конфиг механик: `app/src/main/assets/keyboard_mechanics.json` (варианты по устройствам)
- Конфиг плагинов: `app/src/main/assets/plugin_data.json`
- Конфиг доступности: `app/src/main/assets/k12kb_as_options.json`
- JS-патчи: `app/src/main/assets/js_patches/*.js`
- JSON-схемы: `doc/schema/*.schema.json`

## Ссылки на документацию

- Руководство пользователя (EN): https://k12kb.gitbook.io/doc/en/manual
- Руководство пользователя (RU): https://k12kb.gitbook.io/doc/ru/manual
- Заметки о выпусках: `doc/release_2_4.txt` — `doc/release_2_7.txt`
- JSON-схемы: `doc/schema/` (keyboard_core, keyboard_layouts, keyboard_mechanics, k12kb_as_options, plugin_data, hw, alt_hw)
