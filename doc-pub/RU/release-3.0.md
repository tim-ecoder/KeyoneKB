# Release 3.0

## Release 3.0

Тип: Мажорный релиз\
Версия: v3.0b08a\
Краткое описание: Крупное обновление — ребрендинг в K12KB, нативные движки предиктивного ввода и перевода, клавиатура эмодзи, редизайн интерфейса со светлой/тёмной темой, совместимость с Android 8+

### Описание релиза

Релиз 3.0 посвящен:

* Ребрендинг из KeyoneKB в K12KB с новым namespace и иконкой
* Полноценный движок предиктивного ввода с нативным SymSpell (C99 + JNI)
* Оффлайн-перевод с контекстным фразовым подбором
* Клавиатура эмодзи
* Полный редизайн интерфейса и настроек со светлой/тёмной темой
* Совместимость с Android 8 (Oreo) по Android 12+

### Ребрендинг

* Изменён namespace приложения на `com.ai10.k12kb`
* Все внутренние ссылки переименованы из keyonekb/keyonekb2 в k12kb
* Новая иконка K12KB в тёмно-синих тонах (deep sea blue)
* Версия повышена до 3.0

### Движок предиктивного ввода

* Добавлен предиктивный ввод с панелью подсказок (на базе Pastiera)
* **Нативный движок SymSpell** на C99 с JNI-биндингами для aarch64 — значительно быстрее Java-реализации
* N-gram движок для предсказания следующего слова после пробела и принятия подсказки
* Словари расширены до 750 тысяч слов на базе wordfreq (OpenSubtitles 2018)
* **Переключатели размера словарей** — на выбор: tiny, normal, big и full
* Бинарный формат кеша для быстрой загрузки словарей между перезапусками IME
* Статический движок кеширует словари между перезапусками IME, не перезагружая их
* Последовательная предзагрузка словарей при старте (сначала EN, потом RU)
* Загрузка с тротлингом для предотвращения лагов при наборе текста
* Toast-уведомление при наборе текста во время загрузки словаря
* Статус словарей и управление кешем в экране настроек подсказок
* Настраиваемое количество подсказок (1–6 слотов)
* **Ctrl+W** — переключение панели подсказок вкл/выкл
* Настройка для полного включения/выключения предиктивного ввода
* Настройка для отключения автокапитализации
* Настройка для отключения keyboard-aware коррекций
* Обучение на набираемом тексте (клавиатура учится по мере ввода)
* Интеграция с Android UserDictionary для предиктивного ввода
* Удалён старый N-gram движок, предсказание следующего слова перенесено в нативный SymSpell

### Оффлайн-перевод

* **Оффлайн-перевод из файлов** отображается в подсказках-пилюлях
* **Нативный CDB-based движок перевода** для быстрых словарных запросов
* Словари перевода на основе OpenRussian (словоформы) + Wiktionary
* Контекстный фразовый перевод с использованием биграмных словарей
* Биграмный контекстный словарь для перевода с учётом предыдущего слова
* Фразовый перевод заменяет оба слова при принятии фразового совпадения
* Словари перевода отсортированы по частотности слова целевого языка
* Отдельная настройка количества пилюль перевода
* Переключатели размера словарей перевода (tiny, normal, big, full)
* **Ctrl+T** — переключение перевода вкл/выкл

### Клавиатура эмодзи

* Добавлена клавиатура эмодзи с 5 страницами смайликов
* Заменены Emoji 11.0+ на совместимые Emoji 5.0 для поддержки Android 8.x
* Видимая метка EMO на SYM-панели для быстрого доступа
* Исправлено поведение кнопки эмодзи на SYM-панели

### Панель подсказок

* Панель подсказок перестилизована под дизайн наэкранной клавиатуры
* Динамическая ширина слотов в зависимости от длины текста с пропорциональным взвешиванием
* Приоритетное слово отображается полностью в центральном слоте, никогда не обрезается
* Неприоритетные слова обрезаются с начала (показываются окончания)
* Пустые слоты скрываются, оставшиеся заполняют доступное пространство
* Тёмная полоса-разделитель над панелью подсказок (сверху и снизу)
* Панель подсказок сдвигает контент приложения вверх через onComputeInsets
* Панель остаётся видимой при отключённой свайп-панели
* Увеличено с 3 до 4 слотов подсказок (настраивается до 6)

### Редизайн интерфейса и настроек

* **Светлая тема** с переключателем в настройках
* Редизайн GUI с тёмными пилюлями и компактной раскладкой
* Числа в настройках выделены кружками
* Текст пилюль обрезается многоточием, клик раскрывает полный текст
* Сохранение/загрузка настроек в структурированном JSON (включая секции json\_patches и swipe\_modes)
* Проверка прав доступа к хранилищу для операций с настройками
* Переключатель языка интерфейса на главном экране
* Сворачиваемая группа выданных разрешений с учётом темы оформления
* Перекомпоновка главного экрана с динамическим позиционированием элементов
* Русские переводы экранов настроек (Оформление, Подсказки, Бэкап)

### JS-патчи

* Человекочитаемые имена на пилюлях JS-патчей (из комментариев `// @name` в файлах)
* JS-патчи сгруппированы по имени ресурса с подзаголовками
* Клик по тексту пилюли JS-патча открывает файл в редакторе (отдельно от переключателя)
* Русские переводы toast-сообщений редактора JS-патчей
* Секция JS PATCHES полностью скрыта, если на SD-карте нет файлов патчей
* JS-патчи загружаются только с SD-карты (без автоматической выгрузки из assets)
* **Добавлен JSpatch: Disable chats reading/scrolling** — режим по умолчанию

### Совместимость с Android

* Снижен minSdkVersion до 26 для совместимости с Android Oreo
* Исправлен краш IME на Oreo: notification channels обязательны с API 26
* Исправлен BootstrapMethodError: все Java-лямбды заменены на анонимные внутренние классы
* Исправлен краш уведомлений на Android 12+: PendingIntent FLAG\_IMMUTABLE
* Исправлено отображение иконки уведомления на Android 8+
* Исправлен краш настроек: ambilwarna color picker скомпилирован из исходников
* Исправлен краш: AppCompatActivity заменён на Activity

### Исправленные ошибки

* **BF:** Исправлена утечка памяти при переключении раскладки клавиатуры
* **BF:** Исправлены подсказки, не работавшие после переключения раскладки
* **BF:** Исправлен предиктивный ввод, пропадавший после смены языка
* **BF:** Исправлен краш при смене языка (null-check для layout)
* **BF:** Исправлена незагрузка N-gram движка при переключении с SymSpell
* **BF:** Исправлена медленность набора за счёт кеширования reflection Method при инициализации
* **BF:** Исправлен приоритетный слот, имевший наименьший размер пилюли в панели подсказок
* **BF:** Исправлен текст перевода, всегда отображавшийся синим в панели подсказок
* **BF:** Исправлены медленные подсказки и зависшая панель при сворачивании приложения
* **BF:** Исправлена загрузка настроек: обработка всех числовых типов и корректный перезапуск
* **BF:** Исправлен низкий контраст текста на динамических переключателях в светлой теме
* **BF:** Исправлен конфликт раскрытия пилюли и переключателя
* **BF:** Исправлено расположение бейджа в вертикальных пилюлях (seekbar-элементы)
* **BF:** Исправлен перевод RU->EN: обработка нижнего регистра в Java
* **BF:** Исправлена линковка нативного .so для Android (bionic вместо glibc)
* **BF:** Исправлен путь бэкапа настроек — используется централизованный FileJsonUtils.PATH
* **BF:** Исправлено отсутствие раскладок клавиатуры в APK-сборке
* **BF:** Исправлена логика проверки разрешения на телефон
* **BF:** Исправлена проверка прав на файлы через проверку существования директории
* **BF:** Исправлено сохранение режима свайпа клавиатуры — только при явном изменении пользователем

### Горячие клавиши

| Сочетание      | Действие                              |
| -------------- | ------------------------------------- |
| Ctrl+W         | Переключение панели подсказок вкл/выкл |
| Ctrl+T         | Переключение перевода вкл/выкл         |
